<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ION Game Vault - Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@900&display=swap" rel="stylesheet">
  <!-- VANTA.js and three.js CDN (for animated backgrounds) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.triangles.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.net.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.waves.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.fog.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.cells.min.js"></script>
  <style>
    :root {
      --theme-hue: 210;
      --theme-accent: hsl(var(--theme-hue), 100%, 56%);
      --theme-accent-light: hsl(var(--theme-hue), 100%, 72%);
      --theme-accent-dark: hsl(var(--theme-hue), 72%, 36%);
      --theme-bg: #0a0f2c;
    }
    html, body {
      margin: 0; padding: 0; height: 100%;
      background: var(--theme-bg);
      color: #e0e6f0;
      font-family: 'Montserrat', Arial, sans-serif;
      min-height: 100vh;
      width: 100vw;
      overflow-x: hidden;
      transition: background 0.3s;
    }
    #vanta-bg {
      position: fixed;
      left: 0; top: 0;
      width: 100vw; height: 100vh;
      z-index: 0;
      pointer-events: none;
      display: none;
    }
    body.vanta-bg-active #vanta-bg { display: block !important; }
    body.vanta-bg-active { background: #12193a !important; }
    body.vanta-bg-active::before { display: none !important; }
    body.custom-bg {
      background: var(--custom-bg) no-repeat center center fixed !important;
      background-size: cover !important;
    }
    body[data-bg] {
      background: var(--theme-bg);
    }
    body::before {
      content: '';
      position: fixed;
      left: 0; top: 0;
      width: 100vw; height: 100vh;
      z-index: 0;
      pointer-events: none;
      background:
        radial-gradient(ellipse at 15% 25%, hsla(210,100%,58%,0.15) 0, transparent 60%),
        radial-gradient(ellipse at 80% 60%, hsla(290,100%,60%,0.08) 0, transparent 70%),
        radial-gradient(ellipse at 40% 80%, hsla(120,100%,35%,0.07) 0, transparent 80%),
        linear-gradient(135deg, #12193a 0%, #151e3c 100%);
      animation: move-bg 14s linear infinite alternate;
    }
    @keyframes move-bg {
      0% {
        background-position:
          20% 30%,
          80% 60%,
          40% 80%,
          0 0;
      }
      100% {
        background-position:
          10% 40%,
          70% 70%,
          60% 90%,
          0 0;
      }
    }
    .navbar {
      position: fixed;
      top: 18px;
      right: 32px;
      z-index: 1002;
      background: rgba(10, 15, 44, 0.95);
      border-radius: 14px;
      box-shadow: 0 2px 16px var(--theme-accent-dark, #1e90ff33);
      border: 1.5px solid var(--theme-accent-dark, #1e90ff44);
      padding: 8px 20px 8px 16px;
      display: flex;
      align-items: center;
      gap: 18px;
      font-family: 'Montserrat', Arial, sans-serif;
    }
    .navbar a {
      text-decoration: none;
      color: var(--theme-accent-light);
      font-weight: 600;
      font-size: 1.09rem;
      letter-spacing: 0.04em;
      transition: color 0.16s, text-shadow 0.16s;
      padding: 3px 10px;
      border-radius: 10px;
      position: relative;
    }
    .navbar a:hover, .navbar a:focus-visible {
      color: #fff;
      background: var(--theme-accent);
      text-shadow: 0 0 8px var(--theme-accent-light), 0 0 2px #fff;
      outline: none;
    }
    .navbar .nav-logo {
      font-size: 1.2em;
      font-weight: 700;
      color: var(--theme-accent);
      background: none;
      cursor: pointer;
      padding: 0 10px 0 0;
      letter-spacing: 0.08em;
      text-shadow: 0 0 8px var(--theme-accent-light);
      border: none;
    }
    .container {
      max-width: 900px;
      width: 99vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 2;
      margin: 0 auto;
      margin-top: 110px;
    }
    h1 {
      font-family: 'Montserrat', Arial, sans-serif;
      font-weight: 900;
      font-size: clamp(1.3rem, 7vw, 3.2rem);
      background: linear-gradient(90deg, var(--theme-accent), var(--theme-accent-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
      margin-bottom: 38px;
      text-align: center;
      user-select: none;
      white-space: nowrap;
      border: none;
      box-shadow: none;
      padding: 0;
      text-shadow: none;
      overflow-x: auto;
    }
    @media (max-width: 600px) {
      h1 {
        font-size: clamp(1rem, 6vw, 2.3rem);
        margin-bottom: 28px;
        white-space: normal;
        word-break: break-word;
      }
    }
    .settings-section {
      background: rgba(18,22,44,0.98);
      border-radius: 18px;
      box-shadow: 0 2px 16px var(--theme-accent-dark, #1e90ff33);
      border: 1.5px solid var(--theme-accent-dark, #1e90ff44);
      margin-bottom: 30px;
      padding: 28px 28px 20px 28px;
      width: 100%;
      max-width: 620px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .settings-section h2 {
      margin-top: 0;
      color: var(--theme-accent-light);
      font-size: 1.25rem;
      font-weight: 700;
      letter-spacing: 0.05em;
      margin-bottom: 12px;
    }
    .setting-row {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 8px;
      font-size: 1.08rem;
    }
    .setting-row label, .setting-label {
      flex: 1;
      color: var(--theme-accent-light);
    }
    .dropdown, .input-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .dropdown select, .input-group input[type="text"], .input-group input[type="file"] {
      background: #232b40;
      color: #fff;
      border-radius: 8px;
      border: 1.5px solid var(--theme-accent-dark);
      font-size: 1.07rem;
      padding: 5px 20px 5px 9px;
      font-family: 'Montserrat', Arial, sans-serif;
      appearance: none;
      outline: none;
      transition: border 0.16s;
      box-shadow: 0 1px 4px #0002;
    }
    .color-swatches {
      display: flex;
      gap: 7px;
      flex-wrap: wrap;
    }
    .color-swatch {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      border: 2.5px solid #fff;
      cursor: pointer;
      transition: border 0.16s, box-shadow 0.16s;
      background: #fff;
      margin-right: 2px;
      margin-bottom: 2px;
      box-shadow: 0 0 2px #0003;
    }
    .color-swatch.selected, .color-swatch:focus-visible {
      border: 2.5px solid var(--theme-accent);
      box-shadow: 0 0 0 2px var(--theme-accent-light);
      z-index: 2;
    }
    .bg-thumbs {
      display: flex;
      flex-wrap: wrap;
      gap: 11px;
      margin-top: 5px;
      margin-bottom: 10px;
    }
    .bg-thumb {
      width: 70px;
      height: 44px;
      border-radius: 8px;
      border: 2.5px solid #fff;
      outline: none;
      cursor: pointer;
      object-fit: cover;
      background: #000;
      transition: border 0.16s, box-shadow 0.16s;
      margin-bottom: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .bg-thumb.selected, .bg-thumb:focus-visible {
      border: 2.5px solid var(--theme-accent);
      box-shadow: 0 0 0 2px var(--theme-accent-light);
      z-index: 2;
    }
    .bg-thumb.vanta {
      background: #181b24;
      font-size: 0.83rem;
      color: #e0e6f0;
      font-family: inherit;
      border-style: dashed;
      font-weight: 700;
      letter-spacing: 0.03em;
    }
    .reset-btn, .save-btn, .set-bg-btn {
      padding: 6px 18px;
      border-radius: 7px;
      border: none;
      font-family: 'Montserrat', Arial, sans-serif;
      font-weight: 700;
      font-size: 1.09rem;
      color: #fff;
      background: var(--theme-accent);
      cursor: pointer;
      margin-top: 10px;
      margin-bottom: 7px;
      transition: background 0.18s, box-shadow 0.18s;
      box-shadow: 0 2px 8px #1e90ff55;
    }
    .save-btn {
      background: var(--theme-accent-dark);
      margin-left: 10px;
    }
    .set-bg-btn {
      margin-bottom: 0;
      margin-top: 6px;
      float: right;
      background: var(--theme-accent-dark);
    }
    .input-group input[type="text"] {
      min-width: 180px;
    }
    .input-group input[type="file"] {
      min-width: 180px;
    }
    .row-note, .setting-note {
      font-size: 0.97rem;
      color: #bbc4e4;
      margin-top: 2px;
      margin-bottom: 7px;
    }
  </style>
</head>
<body>
  <div id="vanta-bg"></div>
  <nav class="navbar">
    <span class="nav-logo" tabindex="0" title="ION Game Vault Home">ION</span>
    <a href="index.html" tabindex="0">Home</a>
    <a href="G@MES.html" tabindex="0">Games</a>
    <a href="Apps.html" tabindex="0">Apps</a>
    <a href="PR0XIES.html" tabindex="0">Proxies</a>
    <a href="AI.html" tabindex="0">AI</a>
    <a href="About.html" tabindex="0">About</a>
    <a href="Contact.html" tabindex="0">Contact</a>
    <a href="Settings.html" tabindex="0" style="background:var(--theme-accent-light);color:#181b24;">Settings</a>
  </nav>
  <div class="container">
    <h1>Settings</h1>
    <section class="settings-section" id="cloak-section">
      <h2>Cloaking</h2>
      <div class="setting-row">
        <span class="setting-label">Premade Cloak</span>
        <span class="dropdown">
          <select id="premade-cloak-dropdown">
            <option value="off">Off</option>
            <option value="classroom">Google Classroom</option>
            <option value="sheets">Google Sheets</option>
            <option value="slides">Google Slides</option>
            <option value="docs">Google Docs</option>
            <option value="gmail">Gmail</option>
            <option value="powerschool">PowerSchool</option>
            <option value="studysync">StudySync</option>
            <option value="khan">Khan Academy</option>
            <option value="adobe">Adobe</option>
            <option value="powerpoint">PowerPoint</option>
            <option value="word">Microsoft Word</option>
            <option value="youtube">YouTube</option>
          </select>
        </span>
      </div>
      <div class="setting-row">
        <label for="cloak-now-btn" class="setting-label">Apply Now</label>
        <button id="cloak-now-btn" class="save-btn">Cloak</button>
      </div>
      <div class="setting-row">
        <label for="clickoff-cloak" class="setting-label">Click-Off Cloaking</label>
        <input type="checkbox" id="clickoff-cloak" />
        <span class="setting-note">When enabled, clicking outside the page will auto-apply your selected cloak.</span>
      </div>
    </section>
    <section class="settings-section" id="panic-section">
      <h2>Panic Key</h2>
      <div class="setting-row input-group">
        <label for="panic-key" class="setting-label">Set Panic Key:</label>
        <input type="text" id="panic-key" maxlength="1" placeholder="Key" />
      </div>
      <div class="setting-row input-group">
        <label for="panic-url" class="setting-label">Redirect to URL:</label>
        <input type="text" id="panic-url" placeholder="https://example.com" />
      </div>
      <div class="setting-note">
        Press the panic key anytime to instantly redirect. Leave blank to disable.
      </div>
    </section>
    <section class="settings-section" id="color-section">
      <h2>Theme Color</h2>
      <div class="color-swatches" id="color-swatches">
        <div class="color-swatch" data-hue="210" style="background:hsl(210,100%,56%)"></div>
        <div class="color-swatch" data-hue="0" style="background:hsl(0,100%,56%)"></div>
        <div class="color-swatch" data-hue="30" style="background:hsl(30,100%,56%)"></div>
        <div class="color-swatch" data-hue="50" style="background:hsl(50,100%,56%)"></div>
        <div class="color-swatch" data-hue="120" style="background:hsl(120,100%,40%)"></div>
        <div class="color-swatch" data-hue="180" style="background:hsl(180,100%,40%)"></div>
        <div class="color-swatch" data-hue="270" style="background:hsl(270,100%,60%)"></div>
        <div class="color-swatch" data-hue="320" style="background:hsl(320,100%,60%)"></div>
        <div class="color-swatch" data-hue="220" style="background:hsl(220,10%,52%)"></div>
      </div>
    </section>
    <section class="settings-section" id="mouse-section">
      <h2>Mouse Color</h2>
      <div class="setting-row input-group">
        <label for="mouse-color-picker" class="setting-label">Pick Cursor Color:</label>
        <input type="color" id="mouse-color-picker" value="#1e90ff" style="width:40px;height:40px;padding:0;border:none;background:none;"/>
        <button class="set-bg-btn" id="set-mouse-color-btn">Set Mouse Color</button>
        <button class="reset-btn" id="reset-mouse-color-btn" style="margin-left:8px;">Reset</button>
      </div>
      <span class="row-note">This changes the pointer color across the site. Some browsers may render a colored arrow, others a dot.</span>
    </section>
    <section class="settings-section" id="bg-section">
      <h2>Background</h2>
      <div class="setting-row input-group">
        <label for="bg-file" class="setting-label">Upload Custom Image</label>
        <input type="file" id="bg-file" accept="image/*" />
      </div>
      <div class="row-note">Or choose a Default background:</div>
      <div class="bg-thumbs" id="bg-thumbs"></div>
      <button class="set-bg-btn" id="set-bg-btn">Set Selected Background</button>
      <button class="reset-btn" id="reset-bg-btn">Reset to Default</button>
    </section>
  </div>
  <script>
    // --- Cloaking Data ---
    const cloakData = {
      off: { title: "ION Game Vault - Settings", favicon: "favicon.ico" },
      classroom: { title: "Classes", favicon: "https://ssl.gstatic.com/classroom/ic_product_classroom_32.png" },
      sheets: { title: "Untitled spreadsheet - Google Sheets", favicon: "https://ssl.gstatic.com/docs/spreadsheets/favicon3.ico" },
      slides: { title: "Untitled presentation - Google Slides", favicon: "https://ssl.gstatic.com/docs/presentations/images/favicon5.ico" },
      docs: { title: "Untitled document - Google Docs", favicon: "https://ssl.gstatic.com/docs/doclist/images/infinite_arrow_favicon_5.ico" },
      gmail: { title: "Inbox (1) - user@gmail.com - Gmail", favicon: "https://ssl.gstatic.com/ui/v1/icons/mail/rfr/gmail.ico" },
      powerschool: { title: "PowerSchool", favicon: "https://www.powerschool.com/favicon.ico" },
      studysync: { title: "StudySync", favicon: "https://www.studysync.com/favicon.ico" },
      khan: { title: "Dashboard | Khan Academy", favicon: "https://www.khanacademy.org/favicon.ico" },
      adobe: { title: "Adobe Document Cloud", favicon: "https://www.adobe.com/favicon.ico" },
      powerpoint: { title: "Presentation1 - PowerPoint", favicon: "https://static-00.iconduck.com/assets.00/microsoft-powerpoint-icon-512x512-zik0v4o4.png" },
      word: { title: "Document1 - Word", favicon: "https://static-00.iconduck.com/assets.00/microsoft-word-icon-512x512-zfhk9u2d.png" },
      youtube: { title: "YouTube", favicon: "https://www.youtube.com/s/desktop/6f3f9f34/img/favicon.ico" }
    };
    const defaultBackgrounds = [
      // Provided images: use your actual file URLs or paths for your images
      {name: "Nature Morning", url: "https://i.imgur.com/Xx8b6hC.png", thumb: "https://i.imgur.com/Xx8b6hC.png", type: "provided"},
      {name: "Purple Sunset", url: "https://wallpaperaccess.com/full/1131986.jpg", thumb: "https://wallpaperaccess.com/full/1131986.jpg", type: "provided"},
      // Bing and custom
      {name: "Bing 1", url: "https://www.bing.com/th?id=OHR.BisonWindCave_EN-US1361441703_1920x1080.jpg&rf=LaDigue_1920x1080.jpg&pid=hp", thumb: "https://www.bing.com/th?id=OHR.BisonWindCave_EN-US1361441703_320x180.jpg&rf=LaDigue_320x180.jpg&pid=hp", type: "bing"},
      {name: "Bing 2", url: "https://www.bing.com/th?id=OHR.Moonbow_EN-US1092286051_1920x1080.jpg&rf=LaDigue_1920x1080.jpg&pid=hp", thumb: "https://www.bing.com/th?id=OHR.Moonbow_EN-US1092286051_320x180.jpg&rf=LaDigue_320x180.jpg&pid=hp", type: "bing"},
      {name: "Bing 3", url: "https://www.bing.com/th?id=OHR.ChacoCulture_EN-US0831537418_1920x1080.jpg&rf=LaDigue_1920x1080.jpg&pid=hp", thumb: "https://www.bing.com/th?id=OHR.ChacoCulture_EN-US0831537418_320x180.jpg&rf=LaDigue_320x180.jpg&pid=hp", type: "bing"},
      {name: "Bing 4", url: "https://www.bing.com/th?id=OHR.CrestedButteEagles_EN-US1234567890_1920x1080.jpg&rf=LaDigue_1920x1080.jpg&pid=hp", thumb: "https://www.bing.com/th?id=OHR.CrestedButteEagles_EN-US1234567890_320x180.jpg&rf=LaDigue_320x180.jpg&pid=hp", type: "bing"},
      {name: "Bing 5", url: "https://www.bing.com/th?id=OHR.GreatBear_EN-US9876543210_1920x1080.jpg&rf=LaDigue_1920x1080.jpg&pid=hp", thumb: "https://www.bing.com/th?id=OHR.GreatBear_EN-US9876543210_320x180.jpg&rf=LaDigue_320x180.jpg&pid=hp", type: "bing"},
      // Stylish custom backgrounds
      {name: "Dark Forest", url: "https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1920&q=80", thumb: "https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=320&q=80", type: "custom"},
      {name: "Cyberpunk City", url: "https://images.unsplash.com/photo-1464983953574-0892a716854b?auto=format&fit=crop&w=1920&q=80", thumb: "https://images.unsplash.com/photo-1464983953574-0892a716854b?auto=format&fit=crop&w=320&q=80", type: "custom"},
      {name: "Mountains Blue", url: "https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=1920&q=80", thumb: "https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=320&q=80", type: "custom"},
      {name: "Pixel Night", url: "https://wallpapers.wallhaven.cc/wallpapers/full/wallhaven-3z7y9y.png", thumb: "https://wallpapers.wallhaven.cc/wallpapers/thumb/small/th-3z7y9y.jpg", type: "custom"},
      {name: "Retro Lines", url: "https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?auto=format&fit=crop&w=1920&q=80", thumb: "https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?auto=format&fit=crop&w=320&q=80", type: "custom"},
      {name: "Minimal Ocean", url: "https://images.unsplash.com/photo-1465101178521-c1a9136a3b99?auto=format&fit=crop&w=1920&q=80", thumb: "https://images.unsplash.com/photo-1465101178521-c1a9136a3b99?auto=format&fit=crop&w=320&q=80", type: "custom"},
      {name: "Synthwave Grid", url: "https://wallpapers.wallhaven.cc/wallpapers/full/wallhaven-2y8g6l.jpg", thumb: "https://wallpapers.wallhaven.cc/wallpapers/thumb/small/th-2y8g6l.jpg", type: "custom"},
      {name: "Aurora", url: "https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=1920&q=80", thumb: "https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=320&q=80", type: "custom"},
      {name: "Neon Jungle", url: "https://images.unsplash.com/photo-1519125323398-675f0ddb6308?auto=format&fit=crop&w=1920&q=80", thumb: "https://images.unsplash.com/photo-1519125323398-675f0ddb6308?auto=format&fit=crop&w=320&q=80", type: "custom"},
      {name: "City Dawn", url: "https://images.unsplash.com/photo-1465101178521-c1a9136a3b99?auto=format&fit=crop&w=1920&q=80", thumb: "https://images.unsplash.com/photo-1465101178521-c1a9136a3b99?auto=format&fit=crop&w=320&q=80", type: "custom"},
      {name: "Red Desert", url: "https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1920&q=80", thumb: "https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=320&q=80", type: "custom"},
      // Vanta backgrounds
      {name: "Vanta Triangles", url: "vanta:triangles", thumb: "", type: "vanta"},
      {name: "Vanta Net", url: "vanta:net", thumb: "", type: "vanta"},
      {name: "Vanta Waves", url: "vanta:waves", thumb: "", type: "vanta"},
      {name: "Vanta Fog", url: "vanta:fog", thumb: "", type: "vanta"},
      {name: "Vanta Cells", url: "vanta:cells", thumb: "", type: "vanta"}
    ];
    const CLOAK_KEY = "ion-premade-cloak";
    const PANIC_KEY = "ion-panic-key";
    const PANIC_URL = "ion-panic-url";
    const CLICKOFF_CLOAK_KEY = "ion-clickoff-cloak";
    const THEME_HUE_KEY = "ion-theme-hue";
    const BG_KEY = "ion-bg";
    const CUSTOM_BG_KEY = "ion-custom-bg";
    const VANTA_BG_KEY = "ion-vanta-bg";
    const MOUSE_COLOR_KEY = "ion-mouse-color";
    const defaultMouseColor = "#1e90ff";

    // Mouse Color
    const mouseColorPicker = document.getElementById('mouse-color-picker');
    function svgCursorUrl(color) {
      const svg = `<svg width="32" height="32" xmlns="http://www.w3.org/2000/svg"><polygon points="2,2 30,16 18,18 20,30 14,30 16,18 2,2" fill="${color}" stroke="#222" stroke-width="1.5"/></svg>`;
      return `url('data:image/svg+xml;utf8,${encodeURIComponent(svg)}') 2 2, auto`;
    }
    function applyMouseColor(color) {
      if (!color) color = defaultMouseColor;
      document.body.style.cursor = svgCursorUrl(color);
    }
    function updateMouseColorUI() {
      const color = localStorage.getItem(MOUSE_COLOR_KEY) || defaultMouseColor;
      mouseColorPicker.value = color;
      applyMouseColor(color);
    }
    updateMouseColorUI();
    document.getElementById('set-mouse-color-btn').onclick = function() {
      const color = mouseColorPicker.value || defaultMouseColor;
      localStorage.setItem(MOUSE_COLOR_KEY, color);
      applyMouseColor(color);
    };
    document.getElementById('reset-mouse-color-btn').onclick = function() {
      localStorage.removeItem(MOUSE_COLOR_KEY);
      updateMouseColorUI();
    };
    window.addEventListener('storage', function(e) {
      if (e.key === MOUSE_COLOR_KEY) updateMouseColorUI();
    });

    // -- Cloaking --
    function setCloak(cloakKey) {
      const cloak = cloakData[cloakKey] || cloakData['off'];
      document.title = cloak.title;
      let link = document.querySelector("link[rel~='icon']");
      if (!link) {
        link = document.createElement('link');
        link.rel = 'icon';
        document.head.appendChild(link);
      }
      link.href = cloak.favicon;
    }
    function loadCloakSetting() {
      let val = localStorage.getItem(CLOAK_KEY) || "off";
      document.getElementById('premade-cloak-dropdown').value = val;
      setCloak(val);
    }
    document.getElementById("cloak-now-btn").onclick = function() {
      const cloakKey = document.getElementById('premade-cloak-dropdown').value;
      setCloak(cloakKey);
      localStorage.setItem(CLOAK_KEY, cloakKey);
      window.dispatchEvent(new Event("ionSettingsChanged"));
    };
    document.getElementById('premade-cloak-dropdown').addEventListener("change", function() {
      localStorage.setItem(CLOAK_KEY, this.value);
      setCloak(this.value);
      window.dispatchEvent(new Event("ionSettingsChanged"));
    });
    window.addEventListener("DOMContentLoaded", loadCloakSetting);

    // -- Clickoff Cloaking --
    let clickoffEnabled = false;
    function handleClickoff(e) {
      if (!document.hasFocus() && clickoffEnabled) {
        const cloakKey = localStorage.getItem(CLOAK_KEY) || "off";
        setCloak(cloakKey);
      }
    }
    document.getElementById('clickoff-cloak').addEventListener('change', function() {
      clickoffEnabled = this.checked;
      localStorage.setItem(CLICKOFF_CLOAK_KEY, clickoffEnabled ? "1" : "0");
    });
    if (localStorage.getItem(CLICKOFF_CLOAK_KEY) === "1") {
      document.getElementById('clickoff-cloak').checked = true;
      clickoffEnabled = true;
    }
    window.addEventListener('blur', handleClickoff);

    // -- Panic Key --
    function applyPanicKey(e) {
      if (!e.ctrlKey && !e.altKey && !e.metaKey) {
        const panicKey = localStorage.getItem(PANIC_KEY);
        const panicUrl = localStorage.getItem(PANIC_URL);
        if (panicKey && panicUrl && e.key && e.key.toLowerCase() === panicKey.toLowerCase()) {
          window.location.href = panicUrl;
        }
      }
    }
    document.getElementById('panic-key').addEventListener('input', function() {
      localStorage.setItem(PANIC_KEY, this.value);
    });
    document.getElementById('panic-url').addEventListener('input', function() {
      localStorage.setItem(PANIC_URL, this.value);
    });
    document.getElementById('panic-key').value = localStorage.getItem(PANIC_KEY) || '';
    document.getElementById('panic-url').value = localStorage.getItem(PANIC_URL) || '';
    document.addEventListener('keydown', applyPanicKey);

    // -- Color Change --
    function setThemeHue(hue) {
      document.documentElement.style.setProperty('--theme-hue', hue);
      localStorage.setItem(THEME_HUE_KEY, hue);
      window.dispatchEvent(new Event("ionSettingsChanged"));
    }
    const swatches = document.querySelectorAll('.color-swatch');
    function selectSwatch(hue) {
      swatches.forEach(sw => sw.classList.toggle('selected', sw.dataset.hue === hue));
      setThemeHue(hue);
    }
    swatches.forEach(sw => {
      sw.addEventListener('click', function() {
        selectSwatch(this.dataset.hue);
      });
    });
    const savedHue = localStorage.getItem(THEME_HUE_KEY) || "210";
    selectSwatch(savedHue);

    // -- Backgrounds --
    let tempSelectedBgIdx = null;
    let tempSelectedVantaIdx = null;

    function renderBackgroundThumbs() {
      const bgDiv = document.getElementById('bg-thumbs');
      bgDiv.innerHTML = '';
      defaultBackgrounds.forEach((bg, idx) => {
        if (bg.type === "vanta") {
          const div = document.createElement('div');
          div.className = 'bg-thumb vanta';
          div.innerText = bg.name;
          div.setAttribute('data-vantaidx', idx);
          div.title = bg.name;
          div.onclick = function() {
            document.querySelectorAll('.bg-thumb').forEach(thumb => thumb.classList.remove('selected'));
            div.classList.add('selected');
            tempSelectedBgIdx = null;
            tempSelectedVantaIdx = idx;
          };
          bgDiv.appendChild(div);
        } else {
          const img = document.createElement('img');
          img.src = bg.thumb;
          img.alt = bg.name;
          img.className = 'bg-thumb';
          img.setAttribute('data-bgidx', idx);
          img.title = bg.name;
          img.onclick = function() {
            document.querySelectorAll('.bg-thumb').forEach(thumb => thumb.classList.remove('selected'));
            img.classList.add('selected');
            tempSelectedBgIdx = idx;
            tempSelectedVantaIdx = null;
          };
          bgDiv.appendChild(img);
        }
      });
      highlightSavedBg();
    }
    function highlightSavedBg() {
      const idx = parseInt(localStorage.getItem(BG_KEY));
      const vantaIdx = parseInt(localStorage.getItem(VANTA_BG_KEY));
      document.querySelectorAll('.bg-thumb').forEach((img, i) => {
        if(img.classList.contains('vanta')) {
          img.classList.toggle('selected', i === vantaIdx && !isNaN(vantaIdx));
        } else {
          img.classList.toggle('selected', i === idx && !isNaN(idx));
        }
      });
      tempSelectedBgIdx = null;
      tempSelectedVantaIdx = null;
    }

    document.getElementById('set-bg-btn').onclick = function() {
      if(tempSelectedBgIdx !== null) {
        localStorage.setItem(BG_KEY, tempSelectedBgIdx);
        localStorage.removeItem(VANTA_BG_KEY);
        localStorage.removeItem(CUSTOM_BG_KEY);
      } else if(tempSelectedVantaIdx !== null) {
        localStorage.setItem(VANTA_BG_KEY, tempSelectedVantaIdx);
        localStorage.removeItem(BG_KEY);
        localStorage.removeItem(CUSTOM_BG_KEY);
      }
      highlightSavedBg();
      updateBackground();
    };
    document.getElementById('reset-bg-btn').onclick = function() {
      localStorage.removeItem(CUSTOM_BG_KEY);
      localStorage.removeItem(BG_KEY);
      localStorage.removeItem(VANTA_BG_KEY);
      updateBackground();
      highlightSavedBg();
    };
    document.getElementById('bg-file').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        localStorage.setItem(CUSTOM_BG_KEY, ev.target.result);
        localStorage.removeItem(BG_KEY);
        localStorage.removeItem(VANTA_BG_KEY);
        updateBackground();
        highlightSavedBg();
      };
      reader.readAsDataURL(file);
    });

    function updateBackground() {
      let url = "";
      if (localStorage.getItem(CUSTOM_BG_KEY)) {
        url = localStorage.getItem(CUSTOM_BG_KEY);
        document.body.classList.add('custom-bg');
        document.body.classList.remove('vanta-bg-active');
        document.body.style.background = `url('${url}') no-repeat center center fixed`;
        document.body.style.backgroundSize = "cover";
        destroyVanta();
      } else if (localStorage.getItem(VANTA_BG_KEY)) {
        document.body.classList.remove('custom-bg');
        document.body.classList.add('vanta-bg-active');
        destroyVanta();
        const idx = parseInt(localStorage.getItem(VANTA_BG_KEY));
        applyVantaEffectByIdx(idx);
      } else if (localStorage.getItem(BG_KEY)) {
        document.body.classList.remove('custom-bg');
        document.body.classList.remove('vanta-bg-active');
        destroyVanta();
        const idx = parseInt(localStorage.getItem(BG_KEY));
        if (!isNaN(idx)) {
          url = defaultBackgrounds[idx].url;
          document.body.style.background = `url('${url}') no-repeat center center fixed`;
          document.body.style.backgroundSize = "cover";
        }
      } else {
        document.body.classList.remove('custom-bg');
        document.body.classList.remove('vanta-bg-active');
        destroyVanta();
        document.body.style.background = "";
      }
      // apply mouse color any time background changes
      applyMouseColor(localStorage.getItem(MOUSE_COLOR_KEY));
    }
    function destroyVanta() {
      if (window.vantaEffect && typeof window.vantaEffect.destroy === "function") {
        window.vantaEffect.destroy();
        window.vantaEffect = null;
      }
    }
    function applyVantaEffectByIdx(idx) {
      const vantaDiv = document.getElementById('vanta-bg');
      destroyVanta();
      vantaDiv.style.display = "block";
      switch(idx) {
        case 16: window.vantaEffect = window.VANTA.TRIANGLES({el: vantaDiv, mouseControls:true, touchControls:true, minHeight:200, minWidth:200, scale:1, scaleMobile:1}); break;
        case 17: window.vantaEffect = window.VANTA.NET({el: vantaDiv, mouseControls:true, touchControls:true, minHeight:200, minWidth:200, scale:1, scaleMobile:1}); break;
        case 18: window.vantaEffect = window.VANTA.WAVES({el: vantaDiv, mouseControls:true, touchControls:true, minHeight:200, minWidth:200, scale:1, scaleMobile:1}); break;
        case 19: window.vantaEffect = window.VANTA.FOG({el: vantaDiv, mouseControls:true, touchControls:true, minHeight:200, minWidth:200, scale:1, scaleMobile:1}); break;
        case 20: window.vantaEffect = window.VANTA.CELLS({el: vantaDiv, mouseControls:true, touchControls:true, minHeight:200, minWidth:200, scale:1, scaleMobile:1}); break;
      }
    }
    renderBackgroundThumbs();
    updateBackground();

    // -- Cross-page sync --
    window.addEventListener("ionSettingsChanged", function() {});
    window.addEventListener("storage", function(e) {
      if ([CLOAK_KEY, THEME_HUE_KEY, CUSTOM_BG_KEY, BG_KEY, CLICKOFF_CLOAK_KEY, VANTA_BG_KEY, MOUSE_COLOR_KEY].includes(e.key)) {
        if (e.key === CLOAK_KEY) loadCloakSetting();
        if (e.key === THEME_HUE_KEY) selectSwatch(localStorage.getItem(THEME_HUE_KEY));
        if (e.key === CUSTOM_BG_KEY || e.key === BG_KEY || e.key === VANTA_BG_KEY) updateBackground();
        if (e.key === CLICKOFF_CLOAK_KEY) clickoffEnabled = localStorage.getItem(CLICKOFF_CLOAK_KEY) === "1";
        if (e.key === MOUSE_COLOR_KEY) updateMouseColorUI();
      }
    });
  </script>
</body>
</html>
