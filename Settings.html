<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ION Game Vault - Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@900&display=swap" rel="stylesheet">
  <!-- VANTA.js and three.js CDN (for animated backgrounds) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.triangles.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.net.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.waves.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.fog.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.cells.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.rings.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.clouds.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.halo.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.topology.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.birds.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.globe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.dots.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.clouds2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.blox.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.fox.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.trunk.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.hills.min.js"></script>
  <style>
    :root {
      --theme-hue: 210;
      --theme-accent: hsl(var(--theme-hue), 100%, 56%);
      --theme-accent-light: hsl(var(--theme-hue), 100%, 72%);
      --theme-accent-dark: hsl(var(--theme-hue), 72%, 36%);
      --theme-bg: #0a0f2c;
    }
    html, body {
      margin: 0; padding: 0; height: 100%;
      background: var(--theme-bg);
      color: #e0e6f0;
      font-family: 'Montserrat', Arial, sans-serif;
      min-height: 100vh;
      width: 100vw;
      overflow-x: hidden;
      transition: background 0.3s;
    }
    #vanta-bg {
      position: fixed;
      left: 0; top: 0;
      width: 100vw; height: 100vh;
      z-index: 0;
      pointer-events: none;
      display: none;
    }
    body.vanta-bg-active #vanta-bg { display: block !important; }
    body.vanta-bg-active { background: #12193a !important; }
    body.vanta-bg-active::before { display: none !important; }
    .bg-thumbs {
      display: flex;
      flex-wrap: wrap;
      gap: 11px;
      margin-top: 5px;
      margin-bottom: 10px;
    }
    .bg-thumb {
      width: 120px;
      height: 60px;
      border-radius: 8px;
      border: 2.5px solid #fff;
      outline: none;
      cursor: pointer;
      background: #181b24;
      transition: border 0.16s, box-shadow 0.16s;
      margin-bottom: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.97rem;
      color: #9ecbff;
      font-family: 'Montserrat', Arial, sans-serif;
      font-weight: 700;
      text-align: center;
      user-select: none;
    }
    .bg-thumb.selected, .bg-thumb:focus-visible {
      border: 2.5px solid var(--theme-accent);
      box-shadow: 0 0 0 2px var(--theme-accent-light);
      z-index: 2;
      background: #203c61;
      color: #fff;
    }
    .reset-btn, .save-btn, .set-bg-btn {
      padding: 6px 18px;
      border-radius: 7px;
      border: none;
      font-family: 'Montserrat', Arial, sans-serif;
      font-weight: 700;
      font-size: 1.09rem;
      color: #fff;
      background: var(--theme-accent);
      cursor: pointer;
      margin-top: 10px;
      margin-bottom: 7px;
      transition: background 0.18s, box-shadow 0.18s;
      box-shadow: 0 2px 8px #1e90ff55;
    }
    .save-btn {
      background: var(--theme-accent-dark);
      margin-left: 10px;
    }
    .set-bg-btn {
      margin-bottom: 0;
      margin-top: 6px;
      float: right;
      background: var(--theme-accent-dark);
    }
    .container {
      max-width: 900px;
      width: 99vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 2;
      margin: 0 auto;
      margin-top: 110px;
    }
    h1 {
      font-family: 'Montserrat', Arial, sans-serif;
      font-weight: 900;
      font-size: clamp(1.3rem, 7vw, 3.2rem);
      background: linear-gradient(90deg, var(--theme-accent), var(--theme-accent-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
      margin-bottom: 38px;
      text-align: center;
      user-select: none;
      white-space: nowrap;
      border: none;
      box-shadow: none;
      padding: 0;
      text-shadow: none;
      overflow-x: auto;
    }
    @media (max-width: 600px) {
      h1 {
        font-size: clamp(1rem, 6vw, 2.3rem);
        margin-bottom: 28px;
        white-space: normal;
        word-break: break-word;
      }
    }
    .settings-section {
      background: rgba(18,22,44,0.98);
      border-radius: 18px;
      box-shadow: 0 2px 16px var(--theme-accent-dark, #1e90ff33);
      border: 1.5px solid var(--theme-accent-dark, #1e90ff44);
      margin-bottom: 30px;
      padding: 28px 28px 20px 28px;
      width: 100%;
      max-width: 620px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .settings-section h2 {
      margin-top: 0;
      color: var(--theme-accent-light);
      font-size: 1.25rem;
      font-weight: 700;
      letter-spacing: 0.05em;
      margin-bottom: 12px;
    }
    .setting-row {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 8px;
      font-size: 1.08rem;
    }
    .setting-row label, .setting-label {
      flex: 1;
      color: var(--theme-accent-light);
    }
    .dropdown, .input-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .dropdown select, .input-group input[type="text"], .input-group input[type="file"] {
      background: #232b40;
      color: #fff;
      border-radius: 8px;
      border: 1.5px solid var(--theme-accent-dark);
      font-size: 1.07rem;
      padding: 5px 20px 5px 9px;
      font-family: 'Montserrat', Arial, sans-serif;
      appearance: none;
      outline: none;
      transition: border 0.16s;
      box-shadow: 0 1px 4px #0002;
    }
    .color-swatches {
      display: flex;
      gap: 7px;
      flex-wrap: wrap;
    }
    .color-swatch {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      border: 2.5px solid #fff;
      cursor: pointer;
      transition: border 0.16s, box-shadow 0.16s;
      background: #fff;
      margin-right: 2px;
      margin-bottom: 2px;
      box-shadow: 0 0 2px #0003;
    }
    .color-swatch.selected, .color-swatch:focus-visible {
      border: 2.5px solid var(--theme-accent);
      box-shadow: 0 0 0 2px var(--theme-accent-light);
      z-index: 2;
    }
    .row-note, .setting-note {
      font-size: 0.97rem;
      color: #bbc4e4;
      margin-top: 2px;
      margin-bottom: 7px;
    }
    .vanta-color-row {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 10px;
    }
    .vanta-color-row label {
      color: var(--theme-accent-light);
      font-weight: 600;
      font-size: 1.07rem;
    }
    #vanta-color-slider {
      width: 40px;
      height: 40px;
      padding: 0;
      border: none;
      background: none;
      border-radius: 6px;
      box-shadow: 0 1px 4px #0003;
    }
    #reset-vanta-color {
      border-radius: 6px;
      border: none;
      background: #222;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      padding: 6px 15px;
      font-size: 1.01rem;
      transition: background .15s;
    }
    #reset-vanta-color:active {
      background: #111;
    }
    /* --- NAVBAR FIX --- */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1002;
      background: rgba(10, 15, 44, 0.98);
      border-radius: 0 0 18px 18px;
      box-shadow: 0 2px 16px var(--theme-accent-dark, #1e90ff33);
      border-bottom: 2px solid var(--theme-accent-dark, #1e90ff44);
      padding: 13px 24px 13px 24px;
      display: flex;
      align-items: center;
      gap: 18px;
      font-family: 'Montserrat', Arial, sans-serif;
      height: 60px;
    }
    .navbar .nav-logo {
      font-size: 1.45em;
      font-weight: 900;
      color: var(--theme-accent);
      background: none;
      cursor: pointer;
      padding: 0 18px 0 0;
      letter-spacing: 0.08em;
      text-shadow: 0 0 8px var(--theme-accent-light);
      border: none;
      text-transform: uppercase;
      user-select: none;
    }
    .navbar a {
      text-decoration: none;
      color: var(--theme-accent-light);
      font-weight: 700;
      font-size: 1.13rem;
      letter-spacing: 0.04em;
      transition: color 0.16s, text-shadow 0.16s, background 0.12s;
      padding: 7px 18px;
      border-radius: 10px;
      position: relative;
      margin-right: 5px;
      margin-left: 0;
      display: inline-block;
    }
    .navbar a:last-child { margin-right: 0; }
    .navbar a:hover, .navbar a:focus-visible {
      color: #fff;
      background: var(--theme-accent);
      text-shadow: 0 0 8px var(--theme-accent-light), 0 0 2px #fff;
      outline: none;
    }
    .navbar a[style*="background:var(--theme-accent-light)"] {
      background: var(--theme-accent-light);
      color: #181b24 !important;
      font-weight: 900;
      box-shadow: 0 2px 16px #1e90ff22;
    }
    body { padding-top: 74px; }
    @media (max-width: 800px) {
      .navbar {
        flex-wrap: wrap;
        padding: 10px 3vw 10px 3vw;
        height: auto;
        gap: 8px;
      }
      .navbar a, .navbar .nav-logo {
        font-size: 1.01em;
        padding: 7px 10px;
      }
    }
    @media (max-width: 520px) {
      .navbar {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
        padding: 10px 2vw 10px 2vw;
      }
      .navbar .nav-logo { padding-right: 0; }
      .navbar a { width: 100%; }
    }
  </style>
</head>
<body>
  <div id="vanta-bg"></div>
  <nav class="navbar">
    <span class="nav-logo" tabindex="0" title="ION Game Vault Home">ION</span>
    <a href="index.html" tabindex="0">Home</a>
    <a href="G@MES.html" tabindex="0">Games</a>
    <a href="Apps.html" tabindex="0">Apps</a>
    <a href="PR0XIES.html" tabindex="0">Proxies</a>
    <a href="AI.html" tabindex="0">AI</a>
    <a href="About.html" tabindex="0">About</a>
    <a href="Contact.html" tabindex="0">Contact</a>
    <a href="Settings.html" tabindex="0" style="background:var(--theme-accent-light);color:#181b24;">Settings</a>
  </nav>
  <div class="container">
    <h1>Settings</h1>
    <section class="settings-section" id="cloak-section">
      <h2>Cloaking</h2>
      <div class="setting-row">
        <span class="setting-label">Premade Cloak</span>
        <span class="dropdown">
          <select id="premade-cloak-dropdown">
            <option value="off">Off</option>
            <option value="classroom">Google Classroom</option>
            <option value="sheets">Google Sheets</option>
            <option value="slides">Google Slides</option>
            <option value="docs">Google Docs</option>
            <option value="gmail">Gmail</option>
            <option value="powerschool">PowerSchool</option>
            <option value="studysync">StudySync</option>
            <option value="khan">Khan Academy</option>
            <option value="adobe">Adobe</option>
            <option value="powerpoint">PowerPoint</option>
            <option value="word">Microsoft Word</option>
            <option value="youtube">YouTube</option>
          </select>
        </span>
      </div>
      <div class="setting-row">
        <label for="cloak-now-btn" class="setting-label">Apply Now</label>
        <button id="cloak-now-btn" class="save-btn">Cloak</button>
      </div>
      <div class="setting-row">
        <label for="clickoff-cloak" class="setting-label">Click-Off Cloaking</label>
        <input type="checkbox" id="clickoff-cloak" />
        <span class="setting-note">When enabled, clicking outside the page will auto-apply your selected cloak.</span>
      </div>
    </section>
    <section class="settings-section" id="panic-section">
      <h2>Panic Key</h2>
      <div class="setting-row input-group">
        <label for="panic-key" class="setting-label">Set Panic Key:</label>
        <input type="text" id="panic-key" maxlength="1" placeholder="Key" />
      </div>
      <div class="setting-row input-group">
        <label for="panic-url" class="setting-label">Redirect to URL:</label>
        <input type="text" id="panic-url" placeholder="https://example.com" />
      </div>
      <div class="setting-note">
        Press the panic key anytime to instantly redirect. Leave blank to disable.
      </div>
    </section>
    <section class="settings-section" id="color-section">
      <h2>Theme Color</h2>
      <div class="color-swatches" id="color-swatches">
        <div class="color-swatch" data-hue="210" style="background:hsl(210,100%,56%)"></div>
        <div class="color-swatch" data-hue="0" style="background:hsl(0,100%,56%)"></div>
        <div class="color-swatch" data-hue="30" style="background:hsl(30,100%,56%)"></div>
        <div class="color-swatch" data-hue="50" style="background:hsl(50,100%,56%)"></div>
        <div class="color-swatch" data-hue="120" style="background:hsl(120,100%,40%)"></div>
        <div class="color-swatch" data-hue="180" style="background:hsl(180,100%,40%)"></div>
        <div class="color-swatch" data-hue="270" style="background:hsl(270,100%,60%)"></div>
        <div class="color-swatch" data-hue="320" style="background:hsl(320,100%,60%)"></div>
        <div class="color-swatch" data-hue="220" style="background:hsl(220,10%,52%)"></div>
      </div>
    </section>
    <section class="settings-section" id="bg-section">
      <h2>Background</h2>
      <div class="vanta-color-row">
        <label for="vanta-color-slider">Vanta Color:</label>
        <input type="color" id="vanta-color-slider" />
        <button type="button" id="reset-vanta-color">Reset to Theme Color</button>
      </div>
      <div class="row-note">Choose a Vanta Animated Background:</div>
      <div class="bg-thumbs" id="bg-thumbs"></div>
      <button class="set-bg-btn" id="set-bg-btn">Set Selected Background</button>
      <button class="reset-btn" id="reset-bg-btn">Reset to Default</button>
    </section>
  </div>
  <script>
    // --- Cloaking ---
    const cloakData = {
      off: { title: "ION Game Vault - Settings", favicon: "favicon.ico" },
      classroom: { title: "Classes", favicon: "https://ssl.gstatic.com/classroom/ic_product_classroom_32.png" },
      sheets: { title: "Untitled spreadsheet - Google Sheets", favicon: "https://ssl.gstatic.com/docs/spreadsheets/favicon3.ico" },
      slides: { title: "Untitled presentation - Google Slides", favicon: "https://ssl.gstatic.com/docs/presentations/images/favicon5.ico" },
      docs: { title: "Untitled document - Google Docs", favicon: "https://ssl.gstatic.com/docs/doclist/images/infinite_arrow_favicon_5.ico" },
      gmail: { title: "Inbox (1) - user@gmail.com - Gmail", favicon: "https://ssl.gstatic.com/ui/v1/icons/mail/rfr/gmail.ico" },
      powerschool: { title: "PowerSchool", favicon: "https://www.powerschool.com/favicon.ico" },
      studysync: { title: "StudySync", favicon: "https://www.studysync.com/favicon.ico" },
      khan: { title: "Dashboard | Khan Academy", favicon: "https://www.khanacademy.org/favicon.ico" },
      adobe: { title: "Adobe Document Cloud", favicon: "https://www.adobe.com/favicon.ico" },
      powerpoint: { title: "Presentation1 - PowerPoint", favicon: "https://static-00.iconduck.com/assets.00/microsoft-powerpoint-icon-512x512-zik0v4o4.png" },
      word: { title: "Document1 - Word", favicon: "https://static-00.iconduck.com/assets.00/microsoft-word-icon-512x512-zfhk9u2d.png" },
      youtube: { title: "YouTube", favicon: "https://www.youtube.com/s/desktop/6f3f9f34/img/favicon.ico" }
    };
    const CLOAK_KEY = "ion-premade-cloak";
    const PANIC_KEY = "ion-panic-key";
    const PANIC_URL = "ion-panic-url";
    const CLICKOFF_CLOAK_KEY = "ion-clickoff-cloak";
    const THEME_HUE_KEY = "ion-theme-hue";
    function setCloak(cloakKey) {
      const cloak = cloakData[cloakKey] || cloakData['off'];
      document.title = cloak.title;
      let link = document.querySelector("link[rel~='icon']");
      if (!link) {
        link = document.createElement('link');
        link.rel = 'icon';
        document.head.appendChild(link);
      }
      link.href = cloak.favicon;
    }
    function loadCloakSetting() {
      let val = localStorage.getItem(CLOAK_KEY) || "off";
      document.getElementById('premade-cloak-dropdown').value = val;
      setCloak(val);
    }
    document.getElementById("cloak-now-btn").onclick = function() {
      const cloakKey = document.getElementById('premade-cloak-dropdown').value;
      setCloak(cloakKey);
      localStorage.setItem(CLOAK_KEY, cloakKey);
      window.dispatchEvent(new Event("ionSettingsChanged"));
    };
    document.getElementById('premade-cloak-dropdown').addEventListener("change", function() {
      localStorage.setItem(CLOAK_KEY, this.value);
      setCloak(this.value);
      window.dispatchEvent(new Event("ionSettingsChanged"));
    });
    window.addEventListener("DOMContentLoaded", loadCloakSetting);

    let clickoffEnabled = false;
    function handleClickoff(e) {
      if (!document.hasFocus() && clickoffEnabled) {
        const cloakKey = localStorage.getItem(CLOAK_KEY) || "off";
        setCloak(cloakKey);
      }
    }
    document.getElementById('clickoff-cloak').addEventListener('change', function() {
      clickoffEnabled = this.checked;
      localStorage.setItem(CLICKOFF_CLOAK_KEY, clickoffEnabled ? "1" : "0");
    });
    if (localStorage.getItem(CLICKOFF_CLOAK_KEY) === "1") {
      document.getElementById('clickoff-cloak').checked = true;
      clickoffEnabled = true;
    }
    window.addEventListener('blur', handleClickoff);

    // --- Panic Key ---
    function applyPanicKey(e) {
      if (!e.ctrlKey && !e.altKey && !e.metaKey) {
        const panicKey = localStorage.getItem(PANIC_KEY);
        const panicUrl = localStorage.getItem(PANIC_URL);
        if (panicKey && panicUrl && e.key && e.key.toLowerCase() === panicKey.toLowerCase()) {
          window.location.href = panicUrl;
        }
      }
    }
    document.getElementById('panic-key').addEventListener('input', function() {
      localStorage.setItem(PANIC_KEY, this.value);
    });
    document.getElementById('panic-url').addEventListener('input', function() {
      localStorage.setItem(PANIC_URL, this.value);
    });
    document.getElementById('panic-key').value = localStorage.getItem(PANIC_KEY) || '';
    document.getElementById('panic-url').value = localStorage.getItem(PANIC_URL) || '';
    document.addEventListener('keydown', applyPanicKey);

    // --- Theme Color ---
    function hslToHex(h, s, l) {
      l /= 100;
      const a = s * Math.min(l, 1 - l) / 100;
      const f = n => {
        const k = (n + h / 30) % 12;
        const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
        return Math.round(255 * color).toString(16).padStart(2, '0');
      };
      return `#${f(0)}${f(8)}${f(4)}`;
    }
    function getThemeColorHex() {
      const hue = parseInt(localStorage.getItem(THEME_HUE_KEY) || "210");
      return hslToHex(hue, 100, 56);
    }
    const swatches = document.querySelectorAll('.color-swatch');
    function selectSwatch(hue) {
      swatches.forEach(sw => sw.classList.toggle('selected', sw.dataset.hue === hue));
      localStorage.setItem(THEME_HUE_KEY, hue);
      if (!localStorage.getItem("ion-vanta-color")) {
        vantaColorSlider.value = getThemeColorHex();
        updateVantaBackground();
      }
      window.dispatchEvent(new Event("ionSettingsChanged"));
    }
    swatches.forEach(sw => {
      sw.addEventListener('click', function() {
        selectSwatch(this.dataset.hue);
      });
    });
    const savedHue = localStorage.getItem(THEME_HUE_KEY) || "210";
    selectSwatch(savedHue);

    // --- VANTA BACKGROUNDS + COLOR PICKER ---
    const vantaBackgrounds = [
      { name: "Net", key: "NET" },
      { name: "Triangles", key: "TRIANGLES" },
      { name: "Waves", key: "WAVES" },
      { name: "Fog", key: "FOG" },
      { name: "Cells", key: "CELLS" },
      { name: "Rings", key: "RINGS" },
      { name: "Clouds", key: "CLOUDS" },
      { name: "Halo", key: "HALO" },
      { name: "Topology", key: "TOPOLOGY" },
      { name: "Birds", key: "BIRDS" },
      { name: "Globe", key: "GLOBE" },
      { name: "Dots", key: "DOTS" },
      { name: "Clouds2", key: "CLOUDS2" },
      { name: "Blox", key: "BLOX" },
      { name: "Fox", key: "FOX" },
      { name: "Trunk", key: "TRUNK" },
      { name: "Hills", key: "HILLS" }
    ];
    const VANTA_BG_KEY = "ion-vanta-bg";
    const VANTA_COLOR_KEY = "ion-vanta-color";
    let tempSelectedVantaIdx = null;
    function renderVantaThumbs() {
      const bgDiv = document.getElementById('bg-thumbs');
      bgDiv.innerHTML = '';
      vantaBackgrounds.forEach((bg, idx) => {
        const div = document.createElement('div');
        div.className = 'bg-thumb vanta';
        div.innerText = bg.name;
        div.setAttribute('data-vantaidx', idx);
        div.title = bg.name;
        div.onclick = function() {
          document.querySelectorAll('.bg-thumb').forEach(thumb => thumb.classList.remove('selected'));
          div.classList.add('selected');
          tempSelectedVantaIdx = idx;
        };
        bgDiv.appendChild(div);
      });
      highlightSavedVanta();
    }
    function highlightSavedVanta() {
      const vantaIdx = parseInt(localStorage.getItem(VANTA_BG_KEY));
      document.querySelectorAll('.bg-thumb').forEach((img, i) => {
        img.classList.toggle('selected', i === vantaIdx && !isNaN(vantaIdx));
      });
      tempSelectedVantaIdx = null;
    }
    document.getElementById('set-bg-btn').onclick = function() {
      if(tempSelectedVantaIdx !== null) {
        localStorage.setItem(VANTA_BG_KEY, tempSelectedVantaIdx);
      }
      highlightSavedVanta();
      updateVantaBackground();
    };
    document.getElementById('reset-bg-btn').onclick = function() {
      localStorage.removeItem(VANTA_BG_KEY);
      updateVantaBackground();
      highlightSavedVanta();
    };
    // VANTA color slider logic
    const vantaColorSlider = document.getElementById('vanta-color-slider');
    const resetVantaColorBtn = document.getElementById('reset-vanta-color');
    function getSavedVantaColor() {
      return localStorage.getItem(VANTA_COLOR_KEY) || getThemeColorHex();
    }
    function setVantaColor(hex) {
      localStorage.setItem(VANTA_COLOR_KEY, hex);
      vantaColorSlider.value = hex;
      updateVantaBackground();
    }
    function resetVantaColor() {
      localStorage.removeItem(VANTA_COLOR_KEY);
      vantaColorSlider.value = getThemeColorHex();
      updateVantaBackground();
    }
    vantaColorSlider.addEventListener('input', function() {
      setVantaColor(this.value);
    });
    resetVantaColorBtn.addEventListener('click', function() {
      resetVantaColor();
    });
    // On theme color change, update Vanta color if not overridden
    window.addEventListener("storage", function(e) {
      if (e.key === THEME_HUE_KEY) {
        if (!localStorage.getItem(VANTA_COLOR_KEY)) {
          vantaColorSlider.value = getThemeColorHex();
          updateVantaBackground();
        }
      }
      if (e.key === VANTA_BG_KEY) updateVantaBackground();
    });
    // VANTA loader
    function hexToVanta(hex) {
      return parseInt(hex.replace(/^#/, ''), 16);
    }
    function vantaCommonOptions() {
      let colorHex = getSavedVantaColor();
      let colorInt = hexToVanta(colorHex);
      return {
        color: colorInt, color1: colorInt, color2: colorInt,
        backgroundColor: 0x12193a,
        shininess: 50,
        waveHeight: 10,
        mouseControls: true,
        touchControls: true,
        minHeight: 200.00,
        minWidth: 200.00,
        scale: 1.0,
        scaleMobile: 1.0
      };
    }
    let vantaEffect = null;
    function destroyVanta() {
      if (window.vantaEffect && typeof window.vantaEffect.destroy === "function") {
        window.vantaEffect.destroy();
        window.vantaEffect = null;
      }
    }
    function updateVantaBackground() {
      document.body.classList.add('vanta-bg-active');
      destroyVanta();
      const idx = parseInt(localStorage.getItem(VANTA_BG_KEY));
      if (isNaN(idx) || !vantaBackgrounds[idx]) {
        document.body.classList.remove('vanta-bg-active');
        document.getElementById('vanta-bg').style.display = "none";
        return;
      }
      const bgDef = vantaBackgrounds[idx];
      const vantaDiv = document.getElementById('vanta-bg');
      vantaDiv.style.display = "block";
      const options = vantaCommonOptions();
      switch (bgDef.key) {
        case "TRIANGLES": window.vantaEffect = window.VANTA.TRIANGLES({...options, el: vantaDiv}); break;
        case "NET": window.vantaEffect = window.VANTA.NET({...options, el: vantaDiv}); break;
        case "WAVES": window.vantaEffect = window.VANTA.WAVES({...options, el: vantaDiv}); break;
        case "FOG": window.vantaEffect = window.VANTA.FOG({...options, el: vantaDiv, highlightColor: hexToVanta(getSavedVantaColor()), midtoneColor: hexToVanta(getSavedVantaColor()), lowlightColor: hexToVanta(getSavedVantaColor())}); break;
        case "CELLS": window.vantaEffect = window.VANTA.CELLS({...options, el: vantaDiv}); break;
        case "RINGS": window.vantaEffect = window.VANTA.RINGS({...options, el: vantaDiv}); break;
        case "CLOUDS": window.vantaEffect = window.VANTA.CLOUDS({...options, el: vantaDiv}); break;
        case "HALO": window.vantaEffect = window.VANTA.HALO({...options, el: vantaDiv}); break;
        case "TOPOLOGY": window.vantaEffect = window.VANTA.TOPOLOGY({...options, el: vantaDiv}); break;
        case "BIRDS": window.vantaEffect = window.VANTA.BIRDS({...options, el: vantaDiv, colorMode: "variance"}); break;
        case "GLOBE": window.vantaEffect = window.VANTA.GLOBE({...options, el: vantaDiv}); break;
        case "DOTS": window.vantaEffect = window.VANTA.DOTS({...options, el: vantaDiv}); break;
        case "CLOUDS2": window.vantaEffect = window.VANTA.CLOUDS2({...options, el: vantaDiv}); break;
        case "BLOX": window.vantaEffect = window.VANTA.BLOX({...options, el: vantaDiv}); break;
        case "FOX": window.vantaEffect = window.VANTA.FOX({...options, el: vantaDiv}); break;
        case "TRUNK": window.vantaEffect = window.VANTA.TRUNK({...options, el: vantaDiv}); break;
        case "HILLS": window.vantaEffect = window.VANTA.HILLS({...options, el: vantaDiv}); break;
      }
    }

    // Setup color slider default and listeners
    function setupVantaColorSlider() {
      vantaColorSlider.value = getSavedVantaColor();
    }
    renderVantaThumbs();
    setupVantaColorSlider();
    updateVantaBackground();
  </script>
</body>
</html>
